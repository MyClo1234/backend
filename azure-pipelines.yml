# azure-pipelines.yml

trigger:
- main

pool:
  vmImage: codify-self-host-ci-cd

steps:
# # 1. uv 설치 (공식 스크립트 사용) & 경로 설정
# - script: |
#     curl -LsSf https://astral.sh/uv/install.sh | sh
#     echo '##vso[task.prependpath]/home/vsts/.cargo/bin'
#   displayName: 'Install uv'

# # 2. 의존성 설치
# # uv sync: uv.lock 파일을 기반으로 정확한 버전을 초고속으로 설치합니다.
# # --frozen: CI 환경에서는 lock 파일이 변경되지 않도록 고정하는 옵션입니다.
# - script: |
#     uv sync --frozen
#   displayName: 'Install dependencies with uv'
  # 1. 의존성 설치
  - script: |
      pip install -r requirements.txt
    displayName: "Install dependencies"

  # 2. 배포 파일 압축 (직접 zip 파일 생성)
  - task: ArchiveFiles@2
    displayName: "Archive files"
    inputs:
      rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(System.DefaultWorkingDirectory)/build.zip'
      replaceExistingArchive: true

  # 3. Curl을 이용한 직접 배포 (권한 우회 핵심!)
  # 방금 등록한 변수(DEPLOY_USER, DEPLOY_PWD)를 사용해 로그인하고 파일을 전송합니다.
  - script: |
      curl -X POST -u "$(DEPLOY_USER):$(DEPLOY_PWD)" \
      --data-binary @"$(System.DefaultWorkingDirectory)/build.zip" \
      "https://codify-functions-backend-abb5b4b.scm.azurewebsites.net/api/zipdeploy"
    displayName: "Deploy to Azure Functions using Curl"