trigger:
- main
- dev

pool:
  name: 'codify-self-host-ci-cd'

steps:
  # 1. 배포 파일 압축
  - task: ArchiveFiles@2
    displayName: "Archive files"
    inputs:
      rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(System.DefaultWorkingDirectory)/build.zip'
      replaceExistingArchive: true

  # 2. 정석 DNS 및 인증 설정을 통한 배포
  - script: |
      # 172.16.0.6으로 연결되는 정석 SCM 주소입니다.
      DEPLOY_URL="https://codify-functions-backend-gzaydqgch0ccbdfe.scm.koreacentral-01.azurewebsites.net/api/zipdeploy"
      
      echo "Starting deployment to Private Endpoint (172.16.0.6)..."
      
      # -u 옵션에 $USER:$PASS 환경 변수를 사용하여 특수문자 변형을 방지합니다.
      curl -f -v -u "$USER:$PASS" \
      -H "Content-Type: application/zip" \
      --data-binary @"$(System.DefaultWorkingDirectory)/build.zip" \
      "$DEPLOY_URL"
    displayName: "Deploy to Azure Functions (Final Success)"
    env:
      # Secret 변수를 스크립트에서 안전하게 사용할 수 있도록 매핑합니다.
      # 작은따옴표로 감싸는 것이 정석입니다.
      USER: '$(DEPLOY_USER)'
      PASS: '$(DEPLOY_PWD)'
