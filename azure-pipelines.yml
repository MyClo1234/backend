trigger:
- main
- dev

pool:
  name: 'codify-self-host-ci-cd'

steps:
  # 1. 배포 파일 압축
  - task: ArchiveFiles@2
    displayName: "Archive files"
    inputs:
      rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(System.DefaultWorkingDirectory)/build.zip'
      replaceExistingArchive: true

  # 2. DNS 조회 테스트 (검증용)
  # hosts 파일이 깨끗하므로, 여기서 172.16.0.6이 나와야 정상입니다.
  - script: |
      echo ">>> Verifying DNS Lookup..."
      echo "Looking for: codify-functions-backend.scm.azurewebsites.net"
      nslookup codify-functions-backend.scm.azurewebsites.net
    displayName: "Verify DNS Resolution"

  # 3. 배포 실행 (정석 방법)
  # --resolve(하드코딩) 없이 도메인으로 자연스럽게 찾아갑니다.
  - script: |
      echo "Deploying to: https://codify-functions-backend.scm.azurewebsites.net/api/zipdeploy"
      
      curl -f -v -X POST -u "$(DEPLOY_USER):$(DEPLOY_PWD)" \
      -H "Content-Type: application/zip" \
      --data-binary @"$(System.DefaultWorkingDirectory)/build.zip" \
      "https://codify-functions-backend.scm.azurewebsites.net/api/zipdeploy"
    displayName: "Deploy to Azure Functions"