trigger:
- main
- dev

pool:
  name: 'codify-self-host-ci-cd'

steps:
  - script: |
      echo "System.DefaultWorkingDirectory=$(System.DefaultWorkingDirectory)"
      echo "Build.SourcesDirectory=$(Build.SourcesDirectory)"
      pwd
      ls -al
      find . -maxdepth 3 -type f -name "host.json" -o -name "function_app.py" -o -name "requirements.txt"
    displayName: "Debug: list workspace"

  - task: ArchiveFiles@2
    displayName: "Archive function app"
    inputs:
      rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/build.zip'
      replaceExistingArchive: true

  - script: |
      set -euo pipefail

      # ✅ zipdeploy 대신 publish(OneDeploy 계열)로
      DEPLOY_URL="https://codify-functions-backend-gzaydqgch0ccbdfe.scm.koreacentral-01.azurewebsites.net/api/publish?type=zip"

      echo "Deploy to: $DEPLOY_URL"

      curl -f -v -u "${USER}:${PASS}" \
        -H "Content-Type: application/zip" \
        --data-binary @"$(Build.ArtifactStagingDirectory)/build.zip" \
        "$DEPLOY_URL"
    displayName: "Deploy to Azure Functions (OneDeploy)"
    env:
      USER: '$(DEPLOY_USER)'
      PASS: '$(DEPLOY_PWD)'