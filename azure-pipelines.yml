trigger:
- main
- dev
- test/*

pool:
  name: 'codify-self-host-ci-cd'


steps:
  # 1) PEP 668 회피: venv 만들어서 pip 사용 + .python_packages에 설치
  - script: |
      set -euo pipefail
      
      # 1. Install uv
      curl -LsSf https://astral.sh/uv/install.sh | sh
      source $HOME/.cargo/env || export PATH="$HOME/.local/bin:$PATH"
      
      # 2. Setup venv & clean target
      uv venv .venv
      rm -rf .python_packages
      mkdir -p .python_packages/lib/site-packages

      # ---------------------------------------------------------------
      # [수정됨] 3. Install dependencies with uv (For Azure Linux Environment)
      # Mac에서 빌드하더라도 강제로 'linux'용 라이브러리를 설치합니다.
      # ---------------------------------------------------------------
      echo "Installing dependencies for Linux (x86_64)..."
      uv pip install \
        --target ".python_packages/lib/site-packages" \
        --python-platform linux \
        --python-version 3.11 \
        -r requirements.txt

      # 4. Install dependencies for Testing (into venv)
      source .venv/bin/activate
      uv pip install -r requirements.txt
      uv pip install -r requirements-dev.txt

      echo "Installed packages count:"
      find .python_packages/lib/site-packages -maxdepth 1 -mindepth 1 -print | wc -l

      echo "Sample entries:"
      find .python_packages/lib/site-packages -maxdepth 1 -mindepth 1 -print | sed -n '1,20p'
    displayName: "Install dependencies with uv"

  # 2) Run Tests
  # - script: |
  #     set -euo pipefail
  #     source $HOME/.cargo/env || export PATH="$HOME/.local/bin:$PATH"
  #     source .venv/bin/activate
      
  #     export CI=true
  #     # Self-hosted agent setup: use local Postgres directly
  #     # Connect to 127.0.0.1 to avoid IPv6 issues
  #     # Use the 'choeseonghyeon' user that owns the visible Postgres process
  #     export DATABASE_URL="postgresql://choeseonghyeon@127.0.0.1:5432/codify_test"
      
  #     pytest -v
  #   displayName: "Run Tests with pytest"

  # 3) zip 전에 필수 파일 존재 체크
  - script: |
      set -euo pipefail
      test -f host.json
      test -f function_app.py
      test -f requirements.txt
      test -d .python_packages/lib/site-packages
      echo "OK: host.json/function_app.py/requirements.txt/.python_packages exist"
    displayName: "Verify workspace before zip"

  # 3) zip 만들기 (repo 루트 기준)
  - task: ArchiveFiles@2
    displayName: "Archive function app"
    inputs:
      rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/build.zip'
      replaceExistingArchive: true

  # 4) zip 안에 실제 포함됐는지 확인
  # ⚠️ head 때문에 141 나는 문제 방지: sed -n 사용
  - script: |
      set -euo pipefail
      unzip -l "$(Build.ArtifactStagingDirectory)/build.zip" \
        | grep -E "host.json|function_app.py|requirements.txt|\.python_packages" \
        | sed -n '1,80p'
    displayName: "Verify zip contents"

  # 5) OneDeploy로 배포
  - script: |
      set -euo pipefail

      DEPLOY_URL="https://codify-functions-backend-gzaydqgch0ccbdfe.scm.koreacentral-01.azurewebsites.net/api/publish?type=zip"
      echo "Deploy to: $DEPLOY_URL"

      curl_retry() {
        local retries=$1
        shift

        local count=0
        until curl "$@"; do
          exit=$?
          wait=$((2 ** count))
          count=$((count + 1))
          if [ $count -lt $retries ]; then
            echo "Retry $count/$retries exited $exit, retrying in $wait seconds..."
            sleep $wait
          else
            echo "Retry $count/$retries exited $exit, no more retries left."
            return $exit
          fi
        done
        return 0
      }

      # -f: fail on HTTP error
      # -v: verbose
      # --retry 5: curl internal retry
      # --retry-delay 5: delay between internal retries
      # --retry-connrefused: retry on connection refused
      # --connect-timeout 60: timeout for connection
      # --max-time 300: max time for whole operation
      
      curl_retry 5 -f -v -u "${USER}:${PASS}" \
        --retry 5 \
        --retry-delay 5 \
        --retry-connrefused \
        --connect-timeout 60 \
        --max-time 300 \
        -H "Content-Type: application/zip" \
        --data-binary @"$(Build.ArtifactStagingDirectory)/build.zip" \
        "$DEPLOY_URL"
    displayName: "Deploy to Azure Functions (OneDeploy)"
    env:
      USER: '$(DEPLOY_USER)'
      PASS: '$(DEPLOY_PWD)'
