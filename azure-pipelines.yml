trigger:
- main
- dev

pool:
  name: 'codify-self-host-ci-cd'

steps:
  - task: ArchiveFiles@2
    displayName: "Archive files"
    inputs:
      rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(System.DefaultWorkingDirectory)/build.zip'
      replaceExistingArchive: true

  - script: |
      DEPLOY_URL="https://codify-functions-backend-gzaydqgch0ccbdfe.scm.koreacentral-01.azurewebsites.net/api/zipdeploy"
      
      echo "Starting deployment to Private Endpoint (172.16.0.6)..."
      
      # 변수 치환을 방지하기 위해 $USER 대신 내부 환경 변수 이름을 직접 사용하거나
      # 따옴표 처리를 강화합니다.
      curl -f -v -u "${USER}:${PASS}" \
      -H "Content-Type: application/zip" \
      --data-binary @"$(System.DefaultWorkingDirectory)/build.zip" \
      "$DEPLOY_URL"
    displayName: "Deploy to Azure Functions (Final Success)"
    env:
      # DEPLOY_USER 내의 '$' 기호가 Bash에 의해 해석되지 않도록 처리됩니다.
      USER: $(DEPLOY_USER)
      PASS: $(DEPLOY_PWD)